<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Digital Terrain Model Viewer</title>
    <link rel="stylesheet" href="./vendor/leaflet.css" />
    <style>
      :root {
        color-scheme: dark;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          "Segoe UI", sans-serif;
      }

      html,
      body {
        margin: 0;
        height: 100%;
        background: #101014;
        color: #f7f7f8;
      }

      #app {
        position: relative;
        height: 100%;
        width: 100%;
      }

      #map {
        height: 100%;
        width: 100%;
        position: relative;
        z-index: 0;
      }

      .status {
        position: absolute;
        top: 16px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 16, 0.9);
        padding: 10px 18px;
        border-radius: 999px;
        font-size: 14px;
        letter-spacing: 0.02em;
        box-shadow: 0 8px 28px rgba(0, 0, 0, 0.45);
        z-index: 600;
        transition: opacity 0.3s ease;
      }

      .status.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .progress-indicator {
        position: absolute;
        top: 60px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(10, 10, 16, 0.9);
        padding: 8px 14px;
        border-radius: 999px;
        font-size: 13px;
        letter-spacing: 0.02em;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
        z-index: 600;
        transition: opacity 0.2s ease;
      }

      .progress-indicator.hidden {
        opacity: 0;
        pointer-events: none;
      }

      .search-control {
        position: absolute;
        top: 16px;
        left: 16px;
        z-index: 600;
      }

      .search-control form {
        display: flex;
        gap: 8px;
        background: rgba(10, 10, 16, 0.92);
        padding: 6px 10px;
        border-radius: 8px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.35);
      }

      .search-control input {
        border: none;
        background: rgba(255, 255, 255, 0.08);
        color: #f2f2f5;
        padding: 6px 10px;
        border-radius: 6px;
        width: 200px;
        font-size: 13px;
      }

      .search-control button {
        border: none;
        background: #4da3ff;
        color: #0a0a10;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
      }

      .legend {
        position: absolute;
        bottom: 16px;
        left: 16px;
        background: rgba(10, 10, 16, 0.92);
        border-radius: 12px;
        padding: 14px 16px;
        width: 300px;
        z-index: 500;
        box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
        transition: box-shadow 0.2s ease, transform 0.2s ease;
      }

      .legend.collapsed {
        padding-bottom: 12px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.45);
      }

      .legend-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }

      .legend h2 {
        margin: 0;
        font-size: 15px;
        font-weight: 600;
        letter-spacing: 0.04em;
      }

      .legend-toggle {
        border: none;
        background: rgba(255, 255, 255, 0.08);
        color: #f7f7f8;
        padding: 4px 10px;
        border-radius: 999px;
        font-size: 11px;
        letter-spacing: 0.03em;
        cursor: pointer;
        transition: background 0.2s ease, color 0.2s ease;
      }

      .legend-toggle:hover,
      .legend-toggle:focus-visible {
        background: rgba(255, 255, 255, 0.15);
        color: #fff;
      }

      .legend-content {
        margin-top: 12px;
      }

      .legend.collapsed .legend-content {
        display: none;
      }

      .legend p {
        margin: 6px 0 0;
        font-size: 12px;
        color: #aaa;
      }

      .leaflet-control-locate {
        box-shadow: none !important;
        background: none !important;
        border: none !important;
        margin-bottom: 16px;
      }

      .leaflet-control-locate .locate-button {
        border: none;
        border-radius: 50%;
        width: 48px;
        height: 48px;
        background: rgba(10, 10, 16, 0.92);
        color: #0a0a10;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.45);
        transition: background 0.2s ease, color 0.2s ease;
      }

      .leaflet-control-locate .locate-button:hover,
      .leaflet-control-locate .locate-button:focus-visible {
        background: rgba(77, 163, 255, 0.95);
      }

      .leaflet-control-locate .locate-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      .colorbar {
        margin-top: 12px;
        height: 12px;
        border-radius: 999px;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: linear-gradient(
          90deg,
          #274060,
          #387780,
          #78a890,
          #c1d37f,
          #e6b566,
          #e26b5f
        );
      }

      .range {
        margin-top: 6px;
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        color: #d7d7dc;
      }

      .slider-control {
        margin-top: 14px;
        display: grid;
        grid-template-columns: auto 1fr auto;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #d0d0d6;
      }

      .slider-control input[type="range"] {
        width: 100%;
        accent-color: #5ab0ff;
      }

      .toggle-control {
        margin-top: 12px;
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: #d0d0d6;
      }

      .toggle-control input[type="checkbox"] {
        accent-color: #4da3ff;
      }

      .flood-summary {
        margin-top: 8px;
        font-size: 12px;
        color: #d0d0d6;
      }

      .flood-summary strong {
        color: #7ec9ff;
      }

      .number-control {
        margin-top: 10px;
        display: grid;
        grid-template-columns: auto 1fr;
        align-items: center;
        gap: 10px;
        font-size: 12px;
        color: #d0d0d6;
      }

      .number-control input[type="number"] {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.08);
        color: #f7f7f8;
        border-radius: 6px;
        padding: 6px 8px;
        width: 80px;
      }

      .citation {
        margin-top: 14px;
        font-size: 11px;
        color: #b8b8bf;
        line-height: 1.4;
      }

      .citation a {
        color: #7ec9ff;
        text-decoration: none;
      }

      .cell-value {
        color: #f7f7f8;
        font-size: 11px;
        font-weight: 600;
        text-shadow: 0 0 4px rgba(0, 0, 0, 0.85);
        pointer-events: none;
      }

      .leaflet-control-layers {
        background: rgba(10, 10, 16, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        color: #f7f7f8;
        box-shadow: 0 10px 28px rgba(0, 0, 0, 0.45);
      }

      .leaflet-control-layers-toggle {
        width: 38px;
        height: 38px;
        border-radius: 10px;
        background: rgba(255, 255, 255, 0.06);
        background-image: none !important;
        position: relative;
        overflow: hidden;
      }

      .leaflet-control-layers-toggle::after {
        content: "";
        position: absolute;
        inset: 0;
        margin: auto;
        width: 24px;
        height: 24px;
        background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpolygon points='12 3 3 8 12 13 21 8 12 3' stroke='%23f7f7f8' stroke-width='1.6' stroke-linejoin='round'/%3E%3Cpolyline points='3 13 12 18 21 13' stroke='%23f7f7f8' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpolyline points='3 18 12 23 21 18' stroke='%23f7f7f8' stroke-width='1.6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: center;
        background-size: 22px;
        pointer-events: none;
      }

      .leaflet-control-layers-list {
        padding: 10px;
      }

      .leaflet-control-layers label {
        color: #f2f2f5;
        font-size: 13px;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="map"></div>
      <div class="search-control">
        <form id="search-form">
          <input
            type="text"
            id="search-input"
            placeholder="Search city or lat,lon"
            autocomplete="off"
          />
          <button type="submit">Go</button>
        </form>
      </div>
      <div id="status" class="status">Booting DTM visualizer…</div>
      <div id="progress-indicator" class="progress-indicator hidden">
        Downloading DEM… <span id="progress-value">0%</span>
      </div>
      <aside class="legend">
        <div class="legend-header">
          <h2>Digital Terrain Model</h2>
          <button
            type="button"
            id="legend-toggle"
            class="legend-toggle"
            aria-expanded="true"
            aria-controls="legend-content"
          >
            X
          </button>
        </div>
        <div id="legend-content" class="legend-content">
          <p id="legend-note">Awaiting dataset stats…</p>
          <div class="colorbar"></div>
          <div class="range">
            <span id="legend-min">…</span>
            <span id="legend-max">…</span>
          </div>
          <div class="slider-control">
            <label for="max-slider">Max elevation</label>
            <input
              type="range"
              id="max-slider"
              min="0"
              max="1000"
              value="1000"
              step="1"
              disabled
            />
            <span id="slider-value">…</span>
          </div>
          <div class="slider-control">
            <label for="opacity-slider">Opacity</label>
            <input
              type="range"
              id="opacity-slider"
              min="10"
              max="100"
              value="70"
              step="5"
            />
            <span id="opacity-value">70%</span>
          </div>
          <label class="number-control" for="river-base-input">
            <span>Base river level (m)</span>
            <input
              type="number"
              id="river-base-input"
              min="0"
              step="0.1"
              value="3"
            />
          </label>
          <p class="flood-summary">
            Connected flood cells:
            <strong id="flood-cell-count">0</strong>
          </p>
          <label class="number-control" for="river-seed-input">
            <span>Min river cells</span>
            <input
              type="number"
              id="river-seed-input"
              min="1"
              max="5000"
              value="30"
            />
          </label>
          <div class="slider-control">
            <label for="river-slider">Water height</label>
            <input
              type="range"
              id="river-slider"
              min="0"
              max="15"
              value="3"
              step="0.2"
            />
            <span id="river-slider-value">3.0 m</span>
          </div>
          <label class="toggle-control">
            <input type="checkbox" id="multi-select-toggle" />
            <span>Enable multi-tiles selection</span>
          </label>
          <p class="citation">
            Data source:
            <a
              href="https://doi.org/10.5281/zenodo.14900181"
              target="_blank"
              rel="noreferrer"
            >
              Ho, Y., &amp; Hengl, T. (2025). Global Ensemble Digital Terrain Model 30m
              (GEDTM30).
            </a>
          </p>
        </div>
      </aside>
    </div>

    <script src="./vendor/leaflet.js"></script>
    <script src="./vendor/geotiff.min.js"></script>
    <script src="./app.js"></script>
  </body>
</html>
